<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Painel de Fotos</title>
  <meta name="viewport" content="width=248, height=448, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="app">
    <div id="stage">
      <div id="track"></div>
    </div>

  </div>

  <script>
    const FEED_URL = "http://192.168.0.121:4000/feed.json"; // URL para o feed
    const INTERVALO_MS = 30000;

    // métricas do seu layout
    const POLAROID_H = 230;
    const GAP = 40;
    const STEP = POLAROID_H + GAP;

    // velocidade do loop (px por segundo). Aumente para ficar mais rápido.
    const SPEED_PX_PER_SEC = 90;

    function ordenarPorDataDesc(items) {
      return items.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }

    function criarPolaroid(item) {
      const p = document.createElement("div");
      p.className = "polaroid";

      const img = document.createElement("img");
      img.src = item.url.startsWith('http') ? item.url : "http://192.168.0.121:4000" + item.url;
      img.alt = item.caption || "foto";
      p.appendChild(img);

      return p;
    }

    function setInfo(txt) {
      document.getElementById("info").textContent = txt;
    }

    function montarLoop(items) {
      const track = document.getElementById("track");

      // Se não houverem imagens, exibe a mensagem
      if (!items || items.length === 0) {
        setInfo("nenhuma imagem no feed");
        return;
      }

      // Ordena do mais recente para o mais antigo
      let ordered = ordenarPorDataDesc(items);

      // Remove imagens antigas (para evitar duplicações)
      track.innerHTML = "";

      // Adiciona as fotos várias vezes para garantir o loop contínuo
      // (quanto mais, mais suave o loop)
      for (let i = 0; i < 4; i++) {
        for (const it of ordered) {
          track.appendChild(criarPolaroid(it));
        }
      }

      // Ajusta a distância para o número total de polaroids renderizadas
      const totalPolaroids = track.childElementCount;
      const offset = 0;
      const distance = STEP * totalPolaroids;
      track.style.setProperty("--scroll-distance", `${distance}px`);
      track.style.setProperty("--scroll-offset", `${offset}px`);

      // Calcula a duração da animação baseada na distância e na velocidade
      const durationSec = distance / SPEED_PX_PER_SEC;
      track.style.setProperty("--scroll-duration", `${durationSec}s`);

      // --- Persistência do progresso do looping ---
      // Recupera o tempo de início salvo ou define agora
      let startTimestamp = localStorage.getItem("loopStartTimestamp");
      const now = Date.now();
      if (!startTimestamp) {
        startTimestamp = now;
        localStorage.setItem("loopStartTimestamp", startTimestamp);
      }
      // Calcula o tempo já decorrido
      const elapsed = (now - startTimestamp) / 1000; // em segundos
      // Calcula o percentual já percorrido
      const percent = (elapsed % durationSec) / durationSec;
      // Calcula o deslocamento inicial
      const initialOffset = percent * distance;

      // Aplica o deslocamento inicial via animação customizada
      track.style.animation = `subir var(--scroll-duration, 10s) linear infinite`;
      track.style.animationDelay = `-${percent * durationSec}s`;
      track.classList.add("run");
    }

    // Removida a função de destaque para animação de escala

    async function carregarFeed() {
      try {
        const res = await fetch(FEED_URL, {
          cache: "no-store"
        });
        const feed = await res.json();
        montarLoop(feed.items || []);
      } catch (e) {
        setInfo("EM MANUTENÇÃO!!");
      }
    }

    // Carrega o feed assim que a página é carregada
    carregarFeed();
    // Recarrega o feed a cada 30 segundos
    setInterval(carregarFeed, INTERVALO_MS);
  </script>
</body>
</html>


